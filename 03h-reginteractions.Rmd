# Modifying an Effect {#Reginteractions}

We now have a flexible strategy for modeling a quantitative response:
$$(\text{Response})_i = \beta_0 + \sum_{j=1}^{p} \beta_j (\text{Predictor})_{j,i} + \epsilon_i$$

We have seen that we can model the marginal (or overall) relationship between two variables by including only a single predictor.  However, there is one type of question we have not yet addressed --- assessing the interplay between two variables on the response.  


## Building an Effect-Modifier into the Model
Consider the following question from the [Seismic Activity Case Study](#CaseGreece):

  > Is the relationship between the bracketed distance and the magnitude different depending on the soil condition of where the measurement is taken?

We have already examined a model which predicts the bracketed duration using both the magnitude and the soil conditions:

$$
\begin{aligned}
  (\text{Bracketed Duration})_i &= \beta_0 + \beta_1(\text{Magnitude})_i \\
    &\quad + \beta_2\mathbb{I}(\text{i-th observation has a Rocky soil}) \\
    &\quad + \beta_3\mathbb{I}(\text{i-th observation has Soft soil}) + \epsilon_i
\end{aligned}
$$

Exploring further, we saw this model suggested there were actually three equations in one here, one for each of the soil conditions:
$$
\begin{aligned}
  \text{Intermediate Soil:} &\quad (\text{Bracketed Duration})_i = \beta_0 + \beta_1(\text{Magnitude})_i + \epsilon_i\\
  \text{Rocky Soil:} &\quad (\text{Bracketed Duration})_i = \beta_0 + \beta_2 + \beta_1(\text{Magnitude})_i + \epsilon_i\\
  \text{Soft Soil:} &\quad (\text{Bracketed Duration})_i = \beta_0 + \beta_3 + \beta_1(\text{Magnitude})_i + \epsilon_i
\end{aligned}
$$

Graphically, this was represented by three parallel lines (see Figure \@ref(fig:regmodel-ind-plot)).  The lines are parallel because the coefficient associated with Magnitude is the same in each case: $\beta_1$.  That is, for each soil type, the change in the bracketed duration, on average, for each 1-unit increase in the magnitude of an earthquake is the same.  Our question of interest is essentially, is there evidence that this is not the case?  So, the above model actually represents the model under the null hypothesis of our current question.  Under the null hypothesis, the effect of the magnitude on the bracketed duration (which captures the relationship between these two variables) is the same for all three soil types.  The question is, how do we form the alternative model, which allows the slope to look differently in each soil type.  

Consider adding additional terms to our model above, yielding the following model:
$$
\begin{aligned}
  (\text{Bracketed Duration})_i &= \beta_0 + \beta_1(\text{Magnitude})_i \\
    &\quad + \beta_2\mathbb{I}(\text{i-th observation has a Rocky soil}) \\
    &\quad + \beta_3\mathbb{I}(\text{i-th observation has Soft soil}) \\
    &\quad + \beta_4\mathbb{I}(\text{i-th observation has a Rocky soil})(\text{Magnitude})_i \\
    &\quad + \beta_5\mathbb{I}(\text{i-th observation has Soft soil})(\text{Magnitude})_i + \epsilon_i
\end{aligned}
$$

These two additional terms are formed by taking the product of the indicator variables with the variable magnitude; these products are known as __interaction terms__.

```{definition, label=defn-interaction-term, name="Interaction Term"}
The product of two variables in a regression model.  The product allows the effect of one variable on the response to depend on another, essentially modifying the effect.
```

In order to see the impact of adding these interaction terms, let's consider the model for each soil type:
$$
\begin{aligned}
  \text{Intermediate Soil:} &\quad (\text{Bracketed Duration})_i = \beta_0 + \beta_1(\text{Magnitude})_i + \epsilon_i\\
  \text{Rocky Soil:} &\quad (\text{Bracketed Duration})_i = \left(\beta_0 + \beta_2\right) + \left(\beta_1 + \beta_4\right)(\text{Magnitude})_i + \epsilon_i\\
  \text{Soft Soil:} &\quad (\text{Bracketed Duration})_i = \left(\beta_0 + \beta_3\right) + \left(\beta_1+\beta_5\right)(\text{Magnitude})_i + \epsilon_i
\end{aligned}
$$

Notice that in this revised model, not only is the intercept term different in each model, the slope term in front of the magnitude differs for each soil type.  The model with the interaction terms allows the effect of the magnitude on the bracketed duration to be modified by the soil type.  That is, the effect differs across the soil type.

```{block2, type="rmdtip"}
It is common to believe that the interaction term measures the effect between the two variables in the product.  However, this is incorrect.  The interaction term allows the effect of one variable in the product on the response to differ across the levels of the other variable in the product.
```

Visually, this revised model allows three completely different relationships --- one for each soil type.  This is shown in Figure \@ref(fig:reginteractions-plot).  The question of course is which of the two models is more appropriate.  Is there actually evidence that the more complex model, which allows the relationship to differ for locations with different soil types, is required?  Or, is the more simplistic model, which says the relationship is the same across all locations of different soil types, sufficient?

```{r reginteractions-plot, echo=FALSE, fig.cap="Relationship between bracketed duration and the magnitude of an earthquake after also considering the soil conditions of the measurement location.  The relationship between the bracketed duration and the magnitude are allowd to differ within each type of soil condition."}
ggplot(data = greece.df,
       mapping = aes(x = Magnitude, y = BD02, colour = Soil_Condition)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, size = 1.1) +
  labs(x = "Moment Magnitude of the Earthquake",
       y = "Bracketed Duration (s) at Measurement Location",
       colour = "Soil Conditions") + 
  theme_bw(12) +
  theme(legend.position = "bottom")
```



## Inference for Effect Modifications
We can capture our question of interest in the following hypotheses:

  > $H_0: \beta_3 = \beta_5 = 0$  
  > $H_1:$ At least one of $\beta_3$ or $\beta_5$ is not equal to 0.
  
Notice that if the null hypothesis were true, then the slope would be the same in each of the three soil conditions.  However, if either one of the $\beta$'s is nonzero, then the slope will differ for one of the soil conditions.  So, under the null hypothesis, the lines are parallel; under the alternative hypothesis, at least one of the lines is not parallel.  

Conceptually, testing this model is just like testing any other.  We can generate samples under the null hypothesis, using our reduced model.  For each sample, we can compute the standardized test statistic --- a signal to noise ratio --- measuring the signal in the data (in this case, the evidence for non-parallel lines).  Doing this repeatedly gives us a null distribution allowing us to compute a p-value.  Just as before, if the conditions of the classical regression model hold, then we can model the null distribution analytically using a probability model.

This process relies on our ability to partition the variability.  Consider our model, written here in our compact form:
$$(\text{Bracketed Duration}) \sim \text{Magnitude} + (\text{Soil Conditions}) + (\text{Magnitude})(\text{Soil Conditions})$$

Remember that a model for the data-generating process simply specifies the various sources of variability.  In this case, we have partitioned the variability into the following four components:

  - Magnitude: one reason the bracketed duration differs between two locations is the magnitude of the corresponding earthquake.
  - Soil Conditions: another reason for a difference in the bracketed duration is due to the soil conditions at the measurement site.
  - Interplay between Magnitude and Soil Conditions: in addition, we believe that the effect of the magnitude may differ for various soil conditions.
  - Noise: even for two locations which have the same magnitude and soil conditions, there may be a difference in the bracketed duration.  These differences we cannot resolve and attribute them simply to error.
  
By partitioning the variability, we are able to compute a signal-to-noise ratio.  For each component, we can essentially determine how much variability is explained relative to the noise in the process.  So, despite talking about "regression models," we are still just comparing variabilities; that is, we are still doing an analysis of variance.  For that reason, the way in which this information is often presented is through an ANOVA table.

Specifically, Table \@ref(tab:reginteractions-fit) gives the estimates associated with each parameter, and Table \@ref(tab:reginteractions-anova) presents the corresponding ANOVA table.  The ANOVA table shows how the variability is partitioned.  

```{r reginteractions-fit, echo=FALSE}
fit.greece.int <- lm(BD02 ~ Magnitude + Soil_Condition + 
                       Magnitude:Soil_Condition, data = greece.df)

fit.greece.int %>%
  tidy() %>%
  rename(Term = term,
         Estimate = estimate,
         `Standard Error` = std.error,
         `P-Value` = p.value) %>%
  select(-statistic) %>%
  mutate(Term = recode(Term,
                       "Soil_ConditionRocky" = "Soil Conditions (Rocky)",
                       "Soil_ConditionSoft" = "Soil Conditions (Soft)",
                       "Magnitude:Soil_ConditionRocky" = "Interaction: Magnitude & Rocky Soil",
                       "Magnitude:Soil_ConditionSoft" = "Interaction: Magnitude & Soft Soil"),
         `P-Value` = ifelse(`P-Value`<0.001, "< 0.001", round(`P-Value`, 3))) %>%
  knitr::kable(digits = 3, caption = "Summary of the model fit explaining the bracketed duration as a function of both magnitude and soil condition at the measurement location.  The effect of the magnitude was allowed to differ across soil conditions.")
```

```{r reginteractions-anova, echo=FALSE}
fit.greece.int %>%
  anova() %>%
  tidy() %>%
  rename(Source = term,
         DF = df,
         SS = sumsq,
         MS = meansq,
         F = statistic,
         `P-Value` = p.value) %>%
  mutate(Source = recode(Source,
                         "Soil_Condition" = "Soil Conditions",
                         "Magnitude:Soil_Condition" = "Interaction: Magnitude & Soil Conditions",
                         "Error" = "Residuals"),
         `P-Value` = ifelse(`P-Value`<0.001, "< 0.001", round(`P-Value`, 3))) %>%
  knitr::kable(digits = 3,
               caption = "ANOVA table corresponding to the model fit explaining the bracketed durationa s a function of both magnitude and soil condition at the measurement location.  The effect of the magnitude was allowed to differ across soil conditions.")
```

In both tables, the p-values are computed assuming the conditions of the classical regression model are appropriate.  In Table \@ref(tab:reginteractions-fit), the p-value corresponds to testing if the corresponding parameter is 0, _holding all other parameters fixed_.  The problem is that this tests each parameter separately.  However, we would like to know whether there is any evidence of an interaction.  This cannot be obtained from Table \@ref(tab:reginteractions-fit).  Table \@ref(tab:reginteractions-anova), however, provides p-values comparing whether an entire source is necessary when partitioning the variability.  Assuming the conditions for the classical regression model are appropriate, we have no evidence (p = `r round(tidy(anova(fit.greece.int))[3,6], 3)`) that the effect of the magnitude differs across the various soil conditions.  That is, it is reasonable that the effect of the magnitude is similar for locations with each of the three soil types.
