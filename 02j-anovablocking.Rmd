# Analyzing a Design that Incorporates Blocking {#ANOVAblocking}

In Chapter \@ref(ANOVAdata) we discussed various characteristics of a good study design.  Prior to this chapter, the study design has influenced the interpretations of the results (can we assume cause and effect, for example) but not the analysis itself.  That is, whether the data is from an observational study or a controlled experiment, we used a model of the form
$$\text{Response} \sim \text{Factor}$$

where we had a quantitative response and a categorical predictor (or factor).  However, it is not always the case where the study design and the analysis are unrelated.  When we incorporate blocking into the study design, it has major implications with regard to the study.  This chapter explores those implications.


## What is the Big Deal?
Why does blocking impact our analysis.  Consider Example \@ref(ex:anova-golf) from Chapter \@ref(ANOVAdata); briefly, a study was conducted to determine if the type of seed used on a golf green has an effect on the distance a ball rolls on the green.  This appears to fit into the framework we have been discussing in this unit --- we have a quantitative response (the distance the ball rolls) and a categorical predictor (the type of seed used on the green).  Therefore, we might suggest the following model:
$$\text{Rolling Distance} \sim \text{Seed Variety}$$

Formally, we have that
$$(\text{Rolling Distance})_i = \sum_{j=1}^{5} \mu_j \mathbb{I}(\text{i-th ball rolled on green seeded with variety j}) + \epsilon_i$$

Further, we might assume the following conditions on the distribution of the error term:

  1. The error in the distance one ball rolls is independent of the error in the distance of any other ball.
  2. The variance of the error in the distance a ball rolls is similar for all five seed varieties.
  3. The error in the distance a ball rolls follows a Normal Distribution.
  
The problem now arises.  The errors cannot possibly be independent; in fact, we purposely designed a study in which that was not the case!  Remember the goal of blocking is to group subjects which are alike with respect to some inherent characteristic.  In our example here, the greens with a similar slope were grouped together and the randomization of a green to a particular seeding variety occured within each block (group of greens with similar slope).  That is, we recognized that the way a ball rolls within these greens is quite similar.  So, if the ball rolls a little further on average on a green with a steep slope, then we can expect that it will roll a little further on average for most greens within that same slope block.  This suggests the errors in the rolling distance are not independent.

Since the data is not consistent with the conditions we have placed on the model, we are unable to conduct the same types of analyses (classical or resampling-based) presented in the prior chapters.  We need a new strategy.


## Solution: Partition the Variability
We have seen throughout this unit that the key to measuring a signal is to partition the sources of variability that contribute to the response.  Again, this is best explained through a graphic.  Figure \@ref(fig:anovablocking-golf-raw) presents the rolling distance of the golf balls on the various greens.  

```{r anovablocking-golf-raw, echo=FALSE, fig.cap="Comparison of the rolling distance of golf balls seeded with one of five types of Rye grass.  Greens with similar slopes were grouped prior to randomization.  The slope groups, of which there are 4, are denoted by a common value."}
ggplot(data = golf.df,
       mapping = aes(x = Variety, y = Ball_Roll)) +
  geom_line(mapping = aes(group = Slope_Group)) +
  geom_label(mapping = aes(label = Slope_Group)) +
  labs(x = "Variety of Rye Grass", y = "Mean Distance Traveled (m)") +
  theme_bw(12)
```

Even the way we present the data must account for the relationship present in the observed responses.  Greens which belong to a similar group are indicated on the graphic.  We see that balls rolled on those greens in group 3 tended to travel less distance, compared to balls on other greens.  However, for all groups, the ball tended to roll the furthest when seeded with Variety A.  

This discussion helps to tease out the sources of variability:
  
  - Type of Rye Seed: the distance the ball rolled is potentially related to the type of Rye grass used on the green.  That is, we might expect the distance to be different as we move from one variety to another.  This is reflected in our primary question.
  - Slope of Green: the slope of the green will affect the distance the ball travels.  As a result, greens were grouped.  Therefore, the group to which the green belongs also contributes to the variability in the distance the ball rolls.  While we would like to address this, it is not primarily part of our research question; this is a nuisance variable.
  - Error in the Process: balls do not always roll the same distance, even on two greens within the same slope group and assigned to the same Rye variety.  This is the variability we cannot explain.  It is also a nuisance.
  
The first and third sources of variability mentioned above are what we have been discussing throughout this unit.  The second source of variability is a result of the blocked design.  The solution to our modeling problem is to simply incorporate this additional component of the variability.  As we will see in the next unit, this is a general modeling strategy --- whenever we have additional information which contributes to why there is variability in the response, we incorporate that information into our model.  What is unique here is that we are not particularly interested in the slope of the green; it is a nuisance.  That is, we are not interested in determining which variety of Rye we should place on a green with a particular slope; we actually believe there is probably one superior type of seed regardless of the slope.  Placing the greens into groups was simply to reduce this additional variability.  The fact that the slope group is a nuisance, similar to the overall noise in the data generating process, gives us an idea on how we approach this in our model.

Our overall model is still
$$\text{Rolling Distance} \sim \text{Seed Variety}$$

However, we now need to partition the noise a bit further when we formally write the model; this leads to
$$
\begin{aligned}
  (\text{Rolling Distance})_i &= \sum_{j=1}^{5} \mu_j \mathbb{I}(\text{i-th ball rolled on green seeded with variety j}) \\
    &\quad + \sum_{k=1}^{4} \alpha_k\mathbb{I}(\text{i-th ball rolled on green belonging to slope group k}) \\
    &\quad + \epsilon_i
\end{aligned}
$$

We have essentially added an additional set of noise terms $\alpha_1, \dotsc, \alpha_4$ which capture the additional "bump" we should expect to the distance the ball rolls as a result of being in a particular slope group.  Now, we can place certain conditions on each of these error terms; for example,

  - The bump to the rolling distance is the same for all balls within the same slope group.
  - The bump to the rolling distance for a ball in one group is independent of the bump to the rolling distance for a ball in any other group.
  - The bumps to the rolling distance across groups follows a Normal Distribution.
  - The error in the rolling distance for one ball within a slope group is independent of the error in the rolling distance for a ball within the same slope group.
  - The error in the rolling distance for balls within the same slope group is similar across all seeding varieties.
  - The error in the rolling distance follows a Normal Distribution.
  - The error in the rolling distance is independent of the bump that occurs to a ball for being from a particular slope group.
  
Many of these additional conditions (those placed on the "bumps") cannot be assessed.  Instead, we determine based on the context of the problem whether we feel these assumptions are reasonable.  Further investigation of the details of this model and its conditions is beyond the scope of this course.  We focus on the interpretation of the resulting output.


## Interpreting the Analysis
The resulting output looks similar to what we have seen previously (Table \@ref); the only change is that the variability now includes an additional component to the partition.  As this additional component was a nuisance, we refrain from making any interpretations from this component.  We focus instead on the component of interest: the variability due to the factor.

```{r anovablocking-anova-table, echo=FALSE}
lm(Ball_Roll ~ Variety + Slope_Group, data = golf.df) %>%
  anova() %>%
  tidy() %>%
  rename(Source = term,
         DF = df,
         SS = sumsq,
         MS = meansq,
         F = statistic,
         `P-value` = p.value) %>%
  mutate(Source = recode(Source,
                         "Variety" = "Rye Seed Variety",
                         "Slope_Group" = "Slope Group")) %>%
  add_row(Source = "Total",
          DF = sum(.$DF),
          SS = sum(.$SS)) %>%
  knitr::kable(digits = 3, caption = "ANOVA table summarizing the comparison of the ball roll for different seeding varieties while accounting for the slope of the green.")
```

From the analysis, we have strong evidence (p = 0.002) that the distance a ball rolls, on average, is associated with the type of Rye grass used on the green.  From our initial graphical summary of the data, if you would like a course which has fast greens, we would recommend seeding with Variety A.
